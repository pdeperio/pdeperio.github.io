{%- assign _id = include.id | default: "vr360-" | append: include.src | replace: "/", "-" | replace: ".", "-" -%}
<div class="vr-360-wrapper" id="{{ _id }}" style="max-width:100%;">
  <style>
    .vr-360-wrapper { position: relative; }
    .vr-360-wrapper .vr-360-caption { margin:.5rem 0 0; font-size:.9rem; color:#666; }
    /* Make sure A-Frame canvas receives input */
    .vr-360-wrapper canvas.a-canvas { touch-action: none !important; pointer-events: auto !important; }
    .vr-360-wrapper .a-canvas { cursor: grab; }
    .vr-360-wrapper .a-canvas:active { cursor: grabbing; }
  </style>

  <a-scene
    embedded
    vr-mode-ui="enabled: true"
    renderer="antialias: true"
    style="width: 100%; height: {{ include.height | default: '60vh' }};"
  >
    <a-assets>
      <img id="{{ _id }}-asset" src="{{ include.src | relative_url }}" crossorigin="anonymous">
    </a-assets>

    <!-- 360 still -->
    <a-sky id="{{ _id }}-sky" src="#{{ _id }}-asset" rotation="0 -90 0"></a-sky>

    <!-- Camera: reverse drag direction -->
    <a-entity id="{{ _id }}-cam" camera look-controls="reverseMouseDrag: true; pointerLockEnabled: false" position="0 0 0"></a-entity>
  </a-scene>

  {%- if include.caption -%}
  <p class="vr-360-caption">{{ include.caption }}</p>
  {%- endif -%}

  <script>
  (function(){
    var root  = document.getElementById('{{ _id }}');
    var scene = root.querySelector('a-scene');

    function clamp(v, a, b){ return Math.min(b, Math.max(a, v)); }

    scene.addEventListener('loaded', function(){
      var cam = scene.camera;               // THREE.PerspectiveCamera
      if (!cam) return;

      var fovMin = 30, fovMax = 100;        // zoom bounds (smaller FOV = “zoomed in”)

      // --- Wheel zoom (desktop) ---
      // attach to scene.canvas once it's ready
      var attachWheel = function(){
        var target = scene.canvas || root;
        target.addEventListener('wheel', function(e){
          e.preventDefault();
          var step = (e.deltaY > 0 ? +2 : -2);
          cam.fov = clamp(cam.fov + step, fovMin, fovMax);
          cam.updateProjectionMatrix();
        }, { passive: false });
      };
      if (scene.canvas) attachWheel(); else scene.addEventListener('render-target-loaded', attachWheel);

      // --- Pinch zoom (mobile) ---
      var touches = [];
      root.addEventListener('touchstart', function(e){
        if (e.touches.length >= 2) {
          touches = [e.touches[0], e.touches[1]];
        }
      }, { passive: true });

      root.addEventListener('touchmove', function(e){
        if (e.touches.length >= 2 && touches.length === 2) {
          var t0 = e.touches[0], t1 = e.touches[1];
          var prev = Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
          var curr = Math.hypot(t0.clientX - t1.clientX, t0.clientY - t1.clientY);
          var delta = prev - curr; // pinch-in => positive
          var step = (delta > 0 ? +1.5 : -1.5);
          cam.fov = clamp(cam.fov + step, fovMin, fovMax);
          cam.updateProjectionMatrix();
          touches = [t0, t1];
          e.preventDefault();
        }
      }, { passive: false });
    });
  })();
  </script>

  <noscript>
    <img src="{{ include.src | relative_url }}" alt="360 panorama" style="width:100%;height:auto;">
  </noscript>
</div>
